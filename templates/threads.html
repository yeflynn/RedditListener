{% extends "base.html" %}

{% block title %}Downloaded Threads - RedditListener{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Downloaded Threads</h2>
    <div class="header-actions">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">üì• Download More</a>
        {% if threads %}
        <form method="POST" action="{{ url_for('summarize_all_threads') }}" style="display: inline;">
            <button type="submit" class="btn btn-primary">‚ú® Summarize All</button>
        </form>
        <form method="POST" action="{{ url_for('clear_all') }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete all threads? This cannot be undone.');">
            <button type="submit" class="btn btn-danger">üóëÔ∏è Clear All</button>
        </form>
        {% endif %}
    </div>
</div>

{% if not threads %}
<div class="empty-state">
    <p>No threads downloaded yet.</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary">Download Your First Threads</a>
</div>
{% else %}
<div class="threads-stats">
    <p>Total threads: <strong>{{ threads|length }}</strong></p>
    <p>Summarized: <strong>{{ threads|selectattr('summary')|list|length }}</strong></p>
</div>

<div class="threads-list">
    {% for thread in threads %}
    <div class="thread-card">
        <div class="thread-header">
            <span class="thread-flair">{{ thread.flair or 'General' }}</span>
            <span class="thread-subreddit">r/{{ thread.subreddit }}</span>
        </div>
        
        <h3 class="thread-title">
            <a href="{{ url_for('view_thread', thread_id=thread.id) }}">
                {{ thread.title }}
            </a>
        </h3>
        
        <div class="thread-meta">
            <span>üë§ {{ thread.author }}</span>
            <span>üïí {{ thread.posted_time }}</span>
        </div>
        
        <p class="thread-preview">{{ thread.content[:200] }}{% if thread.content|length > 200 %}...{% endif %}</p>
        
        {% if thread.summary %}
        <div class="thread-summary" id="summary-{{ thread.id }}">
            <strong>AI Summary:</strong>
            <p class="summary-text">{{ thread.summary }}</p>
        </div>
        {% endif %}
        
        <div class="thread-actions">
            <button 
                class="btn btn-small btn-primary summarize-btn" 
                data-thread-id="{{ thread.id }}"
            >
                {% if thread.summary %}‚ôªÔ∏è Regenerate{% else %}‚ú® Generate Summary{% endif %}
            </button>
        </div>
        
        <div class="thread-footer">
            <a href="{{ thread.url }}" target="_blank" class="btn btn-link">View on Reddit ‚Üí</a>
            <a href="{{ url_for('view_thread', thread_id=thread.id) }}" class="btn btn-link">View Details ‚Üí</a>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const summarizeBtns = document.querySelectorAll('.summarize-btn');
    
    summarizeBtns.forEach(btn => {
        btn.addEventListener('click', async function() {
            const threadId = this.getAttribute('data-thread-id');
            const originalText = this.textContent;
            const isRegenerate = originalText.includes('Regenerate');
            
            this.disabled = true;
            this.textContent = '‚è≥ Generating...';
            
            try {
                const response = await fetch(`/summarize/${threadId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update summary inline without page reload
                    const summaryDiv = document.getElementById(`summary-${threadId}`);
                    
                    if (summaryDiv) {
                        // Update existing summary
                        const summaryText = summaryDiv.querySelector('.summary-text');
                        summaryText.textContent = data.summary;
                        
                        // Add flash effect
                        summaryDiv.style.animation = 'flash 0.5s';
                        setTimeout(() => {
                            summaryDiv.style.animation = '';
                        }, 500);
                    } else {
                        // Create new summary div
                        const threadCard = this.closest('.thread-card');
                        const threadPreview = threadCard.querySelector('.thread-preview');
                        
                        const newSummaryDiv = document.createElement('div');
                        newSummaryDiv.className = 'thread-summary';
                        newSummaryDiv.id = `summary-${threadId}`;
                        newSummaryDiv.innerHTML = `
                            <strong>AI Summary:</strong>
                            <p class="summary-text">${data.summary}</p>
                        `;
                        
                        threadPreview.insertAdjacentElement('afterend', newSummaryDiv);
                    }
                    
                    // Update button text
                    this.textContent = '‚ôªÔ∏è Regenerate';
                    this.disabled = false;
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    this.disabled = false;
                    this.textContent = originalText;
                }
            } catch (error) {
                alert('Error generating summary: ' + error);
                this.disabled = false;
                this.textContent = originalText;
            }
        });
    });
});
</script>
<style>
@keyframes flash {
    0%, 100% { background-color: transparent; }
    50% { background-color: rgba(74, 144, 226, 0.2); }
}
</style>
{% endblock %}
