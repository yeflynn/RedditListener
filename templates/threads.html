{% extends "base.html" %}

{% block title %}Downloaded Threads - RedditListener{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Downloaded Threads</h2>
    <div class="header-actions">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">üì• Download More</a>
        {% if threads %}
        <form method="POST" action="{{ url_for('summarize_all_threads') }}" style="display: inline;">
            <button type="submit" class="btn btn-primary">‚ú® Summarize All</button>
        </form>
        <form method="POST" action="{{ url_for('clear_all') }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete all threads? This cannot be undone.');">
            <button type="submit" class="btn btn-danger">üóëÔ∏è Clear All</button>
        </form>
        {% endif %}
    </div>
</div>

<!-- Tag Filter Section -->
{% if all_tags %}
<div class="tag-filter-section">
    <span class="filter-label">Filter by tag:</span>
    <a href="{{ url_for('view_threads') }}" class="tag-filter-btn {% if not current_tag %}active{% endif %}">All</a>
    {% for tag in all_tags %}
    <a href="{{ url_for('view_threads', tag=tag) }}" class="tag-filter-btn tag-{{ tag|lower|replace(' ', '-') }} {% if current_tag == tag %}active{% endif %}">{{ tag }}</a>
    {% endfor %}
</div>
{% endif %}

{% if current_tag %}
<div class="filter-notice">
    <p>Showing threads tagged with: <strong>{{ current_tag }}</strong> <a href="{{ url_for('view_threads') }}">(Clear filter)</a></p>
</div>
{% endif %}

{% if not threads %}
<div class="empty-state">
    {% if current_tag %}
    <p>No threads found with tag "{{ current_tag }}".</p>
    <a href="{{ url_for('view_threads') }}" class="btn btn-secondary">Show All Threads</a>
    {% else %}
    <p>No threads downloaded yet.</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary">Download Your First Threads</a>
    {% endif %}
</div>
{% else %}
<div class="threads-stats">
    <p>Total threads: <strong>{{ threads|length }}</strong></p>
    <p>Summarized: <strong>{{ threads|selectattr('summary')|list|length }}</strong></p>
</div>

<div class="threads-list">
    {% for thread in threads %}
    <div class="thread-card">
        <div class="thread-header">
            <span class="thread-flair">{{ thread.flair or 'General' }}</span>
            <span class="thread-subreddit">r/{{ thread.subreddit }}</span>
        </div>
        
        <h3 class="thread-title">
            <a href="{{ url_for('view_thread', thread_id=thread.id) }}">
                {{ thread.title }}
            </a>
        </h3>
        
        <div class="thread-meta">
            <span>üë§ {{ thread.author }}</span>
            <span>üïí {{ thread.posted_time }}</span>
        </div>
        
        <!-- AI Tags Display -->
        {% if thread.ai_tags %}
        <div class="ai-tags" id="tags-{{ thread.id }}">
            {% for tag in thread.ai_tags.split(',') %}
            {% if tag.strip() %}
            <a href="{{ url_for('view_threads', tag=tag.strip()) }}" class="ai-tag tag-{{ tag.strip()|lower|replace(' ', '-') }}">{{ tag.strip() }}</a>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="ai-tags" id="tags-{{ thread.id }}"></div>
        {% endif %}
        
        <p class="thread-preview">{{ thread.content[:200] }}{% if thread.content|length > 200 %}...{% endif %}</p>
        
        {% if thread.summary %}
        <div class="thread-summary" id="summary-{{ thread.id }}">
            <strong>AI Summary:</strong>
            <p class="summary-text">{{ thread.summary }}</p>
        </div>
        {% endif %}
        
        <div class="thread-actions">
            <button 
                class="btn btn-small btn-primary summarize-btn" 
                data-thread-id="{{ thread.id }}"
            >
                {% if thread.summary %}‚ôªÔ∏è Regenerate{% else %}‚ú® Generate Summary{% endif %}
            </button>
        </div>
        
        <div class="thread-footer">
            <a href="{{ thread.url }}" target="_blank" class="btn btn-link">View on Reddit ‚Üí</a>
            <a href="{{ url_for('view_thread', thread_id=thread.id) }}" class="btn btn-link">View Details ‚Üí</a>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const summarizeBtns = document.querySelectorAll('.summarize-btn');
    
    summarizeBtns.forEach(btn => {
        btn.addEventListener('click', async function() {
            const threadId = this.getAttribute('data-thread-id');
            const originalText = this.textContent;
            const isRegenerate = originalText.includes('Regenerate');
            
            this.disabled = true;
            this.textContent = '‚è≥ Generating...';
            
            try {
                const response = await fetch(`/summarize/${threadId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update summary inline without page reload
                    const summaryDiv = document.getElementById(`summary-${threadId}`);
                    
                    if (summaryDiv) {
                        // Update existing summary
                        const summaryText = summaryDiv.querySelector('.summary-text');
                        summaryText.textContent = data.summary;
                        
                        // Add flash effect
                        summaryDiv.style.animation = 'flash 0.5s';
                        setTimeout(() => {
                            summaryDiv.style.animation = '';
                        }, 500);
                    } else {
                        // Create new summary div
                        const threadCard = this.closest('.thread-card');
                        const threadPreview = threadCard.querySelector('.thread-preview');
                        
                        const newSummaryDiv = document.createElement('div');
                        newSummaryDiv.className = 'thread-summary';
                        newSummaryDiv.id = `summary-${threadId}`;
                        newSummaryDiv.innerHTML = `
                            <strong>AI Summary:</strong>
                            <p class="summary-text">${data.summary}</p>
                        `;
                        
                        threadPreview.insertAdjacentElement('afterend', newSummaryDiv);
                    }
                    
                    // Update tags
                    const tagsDiv = document.getElementById(`tags-${threadId}`);
                    if (tagsDiv && data.tags && data.tags.length > 0) {
                        tagsDiv.innerHTML = data.tags.map(tag => {
                            const tagClass = tag.toLowerCase().replace(' ', '-');
                            return `<a href="/threads?tag=${encodeURIComponent(tag)}" class="ai-tag tag-${tagClass}">${tag}</a>`;
                        }).join('');
                        
                        // Add flash effect to tags
                        tagsDiv.style.animation = 'flash 0.5s';
                        setTimeout(() => {
                            tagsDiv.style.animation = '';
                        }, 500);
                    }
                    
                    // Update button text
                    this.textContent = '‚ôªÔ∏è Regenerate';
                    this.disabled = false;
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    this.disabled = false;
                    this.textContent = originalText;
                }
            } catch (error) {
                alert('Error generating summary: ' + error);
                this.disabled = false;
                this.textContent = originalText;
            }
        });
    });
});
</script>
<style>
@keyframes flash {
    0%, 100% { background-color: transparent; }
    50% { background-color: rgba(74, 144, 226, 0.2); }
}

/* Tag Filter Section */
.tag-filter-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    flex-wrap: wrap;
}

.filter-label {
    font-weight: 600;
    color: #555;
}

.tag-filter-btn {
    padding: 6px 14px;
    border-radius: 20px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
    background: #e9ecef;
    color: #495057;
}

.tag-filter-btn:hover {
    background: #dee2e6;
}

.tag-filter-btn.active {
    background: #4a90e2;
    color: white;
}

.tag-filter-btn.tag-scam {
    background: #ffebee;
    color: #c62828;
}

.tag-filter-btn.tag-scam.active {
    background: #c62828;
    color: white;
}

.tag-filter-btn.tag-product-quality {
    background: #fff3e0;
    color: #e65100;
}

.tag-filter-btn.tag-product-quality.active {
    background: #e65100;
    color: white;
}

.tag-filter-btn.tag-user-experience {
    background: #e3f2fd;
    color: #1565c0;
}

.tag-filter-btn.tag-user-experience.active {
    background: #1565c0;
    color: white;
}

.filter-notice {
    padding: 10px 15px;
    background: #e3f2fd;
    border-radius: 6px;
    margin-bottom: 20px;
}

.filter-notice a {
    color: #1565c0;
    margin-left: 10px;
}

/* AI Tags in Thread Cards */
.ai-tags {
    display: flex;
    gap: 8px;
    margin: 10px 0;
    flex-wrap: wrap;
    min-height: 28px;
}

.ai-tag {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
    text-decoration: none;
    transition: transform 0.2s, box-shadow 0.2s;
}

.ai-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.ai-tag.tag-scam {
    background: linear-gradient(135deg, #ffcdd2, #ef9a9a);
    color: #b71c1c;
}

.ai-tag.tag-product-quality {
    background: linear-gradient(135deg, #ffe0b2, #ffcc80);
    color: #e65100;
}

.ai-tag.tag-user-experience {
    background: linear-gradient(135deg, #bbdefb, #90caf9);
    color: #0d47a1;
}
</style>
{% endblock %}
