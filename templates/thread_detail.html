{% extends "base.html" %}

{% block title %}{{ thread.title }} - RedditListener{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('view_threads') }}" class="btn btn-secondary">‚Üê Back to Threads</a>
</div>

<div class="thread-detail">
    <div class="thread-detail-header">
        <div class="thread-badges">
            <span class="badge badge-subreddit">r/{{ thread.subreddit }}</span>
            <span class="badge badge-flair">{{ thread.flair or 'General' }}</span>
        </div>
        <h1>{{ thread.title }}</h1>
        
        <div class="thread-detail-meta">
            <span>üë§ Posted by {{ thread.author }}</span>
            <span>üïí {{ thread.posted_time }}</span>
            <span>üìÖ Downloaded: {{ thread.downloaded_at[:10] }}</span>
        </div>
    </div>

    <div class="thread-detail-content">
        <h3>Thread Content</h3>
        <div class="content-box">
            {{ thread.content }}
        </div>
    </div>

    <div class="thread-detail-summary" id="summary-section" {% if not thread.summary %}style="display: none;"{% endif %}>
        <h3>AI Summary</h3>
        <div class="summary-box" id="summary-content">
            {{ thread.summary or '' }}
        </div>
        <p class="summary-meta" id="summary-meta">Summarized at: {{ thread.summarized_at[:19] if thread.summarized_at else 'N/A' }}</p>
    </div>

    <div class="thread-detail-actions">
        <button 
            id="summarize-btn" 
            class="btn btn-primary"
            data-thread-id="{{ thread.id }}"
        >
            {% if thread.summary %}‚ôªÔ∏è Regenerate AI Summary{% else %}‚ú® Generate AI Summary{% endif %}
        </button>
    </div>

    <div class="thread-detail-links">
        <a href="{{ thread.url }}" target="_blank" class="btn btn-primary">
            View Original Thread on Reddit ‚Üí
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const summarizeBtn = document.getElementById('summarize-btn');
    
    if (summarizeBtn) {
        summarizeBtn.addEventListener('click', async function() {
            const threadId = this.getAttribute('data-thread-id');
            const summarySection = document.getElementById('summary-section');
            const summaryContent = document.getElementById('summary-content');
            const summaryMeta = document.getElementById('summary-meta');
            
            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = '‚è≥ Generating summary...';
            
            try {
                const response = await fetch(`/summarize/${threadId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Show summary section if hidden
                    summarySection.style.display = 'block';
                    
                    // Update summary content
                    summaryContent.textContent = data.summary;
                    
                    // Update timestamp
                    const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
                    summaryMeta.textContent = `Summarized at: ${now}`;
                    
                    // Re-enable button and change text to Regenerate
                    this.disabled = false;
                    this.textContent = '‚ôªÔ∏è Regenerate AI Summary';
                    
                    // Scroll to summary
                    summarySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Summarization error:', error);
                alert('Error generating summary: ' + error.message);
                this.disabled = false;
                this.textContent = originalText;
            }
        });
    }
});
</script>
{% endblock %}
